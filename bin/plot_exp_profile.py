""" Plots the CDFs of the job and workflow results of an experiment. It also
prints the numeric values of existing stats of the experiment. It uses
pre-calculated data from the database generated by the run_analysis_XXX.py
scripts.

Usage:

python ./plot_exp.py trace_id [name]

Args:
- trace_id: numeric id of the experiment to plot and print about.
- name: name of the experiment, prepended to outputed files. If not set,
    database name is used.

Output:
- Plot PNG files are stored in ./out folder. 

Env vars:
- ANALYSIS_DB_HOST: hostname of the system hosting the database.
- ANALYSIS_DB_NAME: database name to read from.
- ANALYSIS_DB_USER: user to be used to access the database.
- ANALYSIS_DB_PASS: password to be used to used to access the database.
- ANALYSIS_DB_PORT: port on which the database runs.
"""
import os
import sys

from orchestration import get_central_db
from orchestration.definition import ExperimentDefinition
from plot import histogram_cdf
from stats.trace import ResultTrace


db_obj = get_central_db()

if len(sys.argv)<2:
    raise ValueError("At least one argument must specified with the trace_id"
                     " to plot.")
trace_id = int(sys.argv[1])
arg_name=None
dest_dir="./out"
if not(os.path.exists(dest_dir)):
    os.makedirs(dest_dir)
    
if len(sys.argv)==3:
    arg_name = sys.argv[2]
    
ed = ExperimentDefinition()
ed.load(db_obj, trace_id)
rt = ResultTrace()
rt.load_analysis(db_obj, trace_id)
if arg_name is None:
    arg_name = ed._name
  
for (key, result) in rt.jobs_results.iteritems():
    if "_cdf" in key:
        bins, edges = result.get_data()
        histogram_cdf(edges, bins, key, file_name=arg_name+"-"+key, 
                      x_axis_label=key, y_axis_label="Norm share",
                      target_folder=dest_dir, do_cdf=True,
                      x_log_scale=True)
    elif "_stats" in key:
        print key, result.get_data()

for (key, result) in rt.workflow_results.iteritems():
    if "_cdf" in key:
        bins, edges = result.get_data()
        if bins is None or edges is None:
            print key, "no workflows detected"
            continue
        histogram_cdf(edges, bins, key, file_name=arg_name+"-"+key, 
                      x_axis_label=key, y_axis_label="Norm share",
                      target_folder=dest_dir, do_cdf=True,
                      x_log_scale=True)
    elif "_stats" in key:
        print key, result.get_data()
        